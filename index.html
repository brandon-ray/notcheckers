<!doctype html>
<html>
<head>
    <title>Not Checkers</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font: 13px Helvetica, Arial; }

        .checker {
            width: 50px;
            height: 50px;
            border-radius: 1000px;
        }

        .selected {
            border: 4px solid yellow;
        }

        .clickable {
            cursor: pointer;
        }

        .checker-1 {
            background-color: red;
        }

        .checker-2 {
            background-color: black;
        }

        .checker-3 {
            background-color: blue;
        }

        .checker-4 {
            background-color: green;
        }

        .no-select {
            user-select: none;
            -o-user-select:none;
            -moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
        }

        table {
            border: 1px solid black;
            padding: 0;
            margin: 0;
        }

        tr td
        {
            background-color: #fff;
            width: 50px;
            height: 50px;
        }

        tr:nth-child(even) td:nth-child(odd),
        tr:nth-child(odd) td:nth-child(even)
        {
            background-color: #ccc;
        }
    </style>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
<body>
<div class="text-center" id="login">
    <br><br>
    <div style="width:300px; margin-left:auto; margin-right:auto;">
        <form onsubmit="game.start(event)" class="well text-left" style="margin:1px;">
            <h2 class="text-center"><b>Not</b> Checkers</h2>
            <br>
            <div class="login-group">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" class="form-control" id="name" name="name" placeholder="Name" required="required">
                </div>
                <button type="submit" class="btn btn-primary pull-right"><i class="fa fa-play"></i> Play</button>
                <div class="form-group login-group-checkbox">
                    <input type="checkbox" id="lg_remember" name="lg_remember">
                    <label for="lg_remember">Remember?</label>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="well no-select" id="game" style="display:none;">
    <div class="row">
        <div class="col-md-6">
            <div id="gameBoard"></div>
        </div>
        <div class="col-md-2"></div>
        <div class="col-md-4 text-left">
            <div id="userState">
                <h2>Welcome to <b>Not</b> Checkers</h2>
                <p>This looks like checkers but it really isn't. <i>Really.</i></p>
                <br><br>
                <h3 id="teamTurn"></h3>
                <h4 id="userTeam"></h4>
                <br><br>
                <h3>Scores</h3>
                <div id="scores"></div>
            </div>
        </div>
    </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
    var game = {};

    game.start = function(event) {
        event.preventDefault();
        var name = $('#name').val();
        console.log(name);
        if (name && name.length > 4 && name.length < 50) {
            init(name);
        } else {
            alert('Invalid name, length must be greater than 4 and less than 50.');
        }
    };

    function init(name) {
        $('#login').hide();
        $('#game').fadeIn();

        var socket = io(window.href, {
            query: 'name=' + name
        });
        var gameState = {};
        var userState = {};
        var teamColor = null;
        var selected = null;
        socket.on('connection', function () {
            console.log('Websocket connected.');
        });

        var teams = {
            1: 'red',
            2: 'black',
            3: 'blue',
            4: 'green'
        };

        socket.on('userState', function (newUserState) {
            userState = newUserState;
            teamColor = teams[userState.team];

            $('#userTeam').html('You are on the <b style="color:' + teamColor + ';">' + teamColor + '</b> team.');
        });

        game.selectChecker = function (val, x, y) {
            if (val === 0) {
                if (selected) {
                    socket.emit('move', {
                        selected: selected,
                        to: {
                            x: x,
                            y: y
                        }
                    });
                }

                selected = null;
                game.redrawBoard();
            } else {
                if (gameState.teamTurn === userState.team && val === userState.team) {
                    selected = {
                        x: x,
                        y: y
                    };
                    game.redrawBoard();
                }
            }
        };

        game.redrawBoard = function () {
            var html = '<table>';
            var scores = {};
            for (var y = 0; y < gameState.board.length; y++) {
                var row = gameState.board[y];
                html += '<tr>';
                for (var x = 0; x < row.length; x++) {
                    var val = row[x];

                    if (scores[val]) {
                        scores[val]++;
                    } else {
                        scores[val] = 1;
                    }

                    html += '<td onclick="game.selectChecker(' + val + ',' + x + ',' + y + ')">';
                    if (val === userState.team) {
                        var selectedClass = '';
                        if (selected && x === selected.x && y === selected.y) {
                            selectedClass = 'selected';
                        }
                        html += '<div class="checker ' + selectedClass + ' checker-' + val + '">&nbsp;</div>';
                    } else {
                        html += '<div class="checker checker-' + val + '">&nbsp;</div>';
                    }
                    html += '</td>';
                }
                html += '</tr>';
            }
            html += '</table>';
            $('#gameBoard').html(html);

            var scoreArray = [];
            for (var i = 0; i < Object.keys(scores).length; i++) {
                var key = Object.keys(scores)[i];
                var score = scores[key];
                if (key > 0) {
                    scoreArray.push({
                        team: key,
                        score: score
                    });
                }
            }

            scoreArray.sort(function (a, b) {
                return b.score - a.score;
            });

            var scoreHtml = '<ol>';
            for (var j = 0; j < scoreArray.length; j++) {
                var score = scoreArray[j];
                var scoreColor = teams[score.team];

                var userList = '';
                for (var k = 0; k < Object.keys(gameState.users).length; k++) {
                    var user = gameState.users[Object.keys(gameState.users)[k]];
                    if (user.team == score.team) {
                        userList += user.name + ' ';
                    }
                }

                scoreHtml += '<li><h4 style="color:' + scoreColor + ';">' + scoreColor + ': ' + score.score + ' - ' + userList + '</h4></li>';
            }
            scoreHtml += '</ol>';
            $('#scores').html(scoreHtml);
        };

        socket.on('gameState', function (newGameState) {
            selected = null;
            gameState = newGameState;
            game.redrawBoard();

            if (gameState.teamTurn === userState.team) {
                $('#teamTurn').html('It is <b style="color:' + teamColor + ';">your</b> team\'s turn.');
            } else {
                var turnColor = teams[gameState.teamTurn];
                $('#teamTurn').html('It is the <b style="color:' + turnColor + ';">' + turnColor + '</b> team\'s turn.');
            }
        });
    }
</script>
</body>
</html>